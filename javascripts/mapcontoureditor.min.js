!function(t){function o(t,o,i,e,r,a){function s(n,e){if(0>n||n>=o||0>e||e>=i)return!1;var r=(e*o+n)*u;return h[0]>=t[r]-c&&h[0]<=t[r]+c&&h[1]>=t[r+1]-c&&h[1]<=t[r+1]+c&&h[2]>=t[r+2]-c&&h[2]<=t[r+2]+c?!0:!1}for(var u=4,c=a.tolerance,f=(r*o+e)*u,h=[t[f],t[f+1],t[f+2]],d=[],p=r;s(e,++p););--p;var g,l=[e,p],m=new n(l);do{if(g=m.next(s),void 0==g)break;d.push(g)}while(l[0]!=g[0]||l[1]!=g[1]);return d}function n(t){function o(t){for(var o=0;8>o;++o){var n=i[o];if(n[0]==t[0]&&n[1]==t[1])return i[(o+1)%8]}}function n(t,n){var i=t[0]-n[0],e=t[1]-n[1],r=o([-i,-e]);return[t[0]+r[0],t[1]+r[1]]}var i=[[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1]],e=t[0],r=t[1],a=[e,r+1];this.next=function(t){for(var o=8;o--;){var i=n([e,r],a);if(t(i[0],i[1]))return e=i[0],r=i[1],[e,r];a=i}}}function i(t,o,n){var i=o[0],e=o[1],r=n[0]-i,a=n[1]-e;if(0!==r||0!==a){var s=((t[0]-i)*r+(t[1]-e)*a)/(r*r+a*a);s>1?(i=n[0],e=n[1]):s>0&&(i+=r*s,e+=a*s)}return r=t[0]-i,a=t[1]-e,r*r+a*a}function e(t,o){var n,e,r,a,s=t.length,u=Array,c=new u(s),f=0,h=s-1,d=[],p=[];for(c[f]=c[h]=1;h;){for(e=0,n=f+1;h>n;n++)r=i(t[n],t[f],t[h]),r>e&&(a=n,e=r);e>o&&(c[a]=1,d.push(f,a,a,h)),h=d.pop(),f=d.pop()}for(n=0;s>n;n++)c[n]&&p.push(t[n]);return p}var r,a,s,u,c,f,h,d={contour:{},tolerance:20,cback:"rgba(120,0,0,0.3)",cborder:"rgba(255,0,0,0.3)",msize:2,mback:"rgba(255,255,255,0.5)",mborder:"rgba(255,0,0,0.5)",magicStick:1},p={init:function(o){var n=t.extend({},d,o),i=0;return this.each(function(){var o=t(this).data("uid");if(!o){n.width=t(this).width(),n.height=t(this).height();var e=new Date;n.uid=e.getTime().toString()+i.toString(),i++;var r=t(this).offset();t("body").append('<div id="d'+n.uid+'" style="position:absolute;z-index:9999;top:'+r.top+"px;left:"+r.left+"px;width:"+n.width+"px;height:"+n.height+'px;display:block;margin:0;padding:0;"><canvas id="c'+n.uid+'" style="width:'+n.width+"px;height:"+n.height+'px;"></canvas></div>'),n.ctx=t("#c"+n.uid)[0].getContext("2d"),n.ctx.canvas.width=n.width,n.ctx.canvas.height=n.height,n.src=t(this).attr("src"),n.sourceObject=t(this),t("#c"+n.uid).data(n),t(this).data({uid:n.uid}),a(n),t("#c"+n.uid).bind("mousedown.mapContourEditor",s),t("#c"+n.uid).bind("contextmenu.mapContourEditor",u),t("#c"+n.uid).bind("mouseup.mapContourEditor",c)}})},getData:function(o){return"undefined"!=typeof t("#c"+t(this).data("uid")).data(o)?t("#c"+t(this).data("uid")).data(o):void 0},setData:function(o){return this.each(function(){t("#c"+t(this).data("uid")).data(o)})},destroy:function(){return this.each(function(){var o=t(this);t("#d"+o.data("uid")).remove(),o.removeData(),t(this).unbind("mapContourEditor")})}};t.fn.mapContourEditor=function(o){if(t(this).is("img")){if(p[o])return p[o].apply(this,Array.prototype.slice.call(arguments,1));if("object"==typeof o||!o)return p.init.apply(this,arguments);t.error('Method "'+o+'" not found in jQuery.mapContourEditor')}else t.error("jQuery.mapContourEditor can be applied to IMG elements only!")},f=function(t,o,n,i,e,r,a){function s(t,o,n,i){return Math.sqrt((t-=n)*t+(o-=i)*o)}if(!a||(a=function(t,o,n,i,e,r){if(!(e-n))return{x:n,y:o};if(!(r-i))return{x:t,y:i};var a,s=-1/((r-i)/(e-n));return{x:a=(e*(t*s-o+i)+n*(t*-s+o-r))/(s*(e-n)+i-r),y:s*a-s*t+o}}(t,o,n,i,e,r),a.x>=Math.min(n,e)&&a.x<=Math.max(n,e)&&a.y>=Math.min(i,r)&&a.y<=Math.max(i,r))){var u=i-r,c=e-n,f=n*r-i*e;return Math.abs(u*t+c*o+f)/Math.sqrt(u*u+c*c)}var h=s(t,o,n,i),d=s(t,o,e,r);return h>d?d:h},a=function(t){var o=t.ctx;if(o.canvas.width=o.canvas.width,t.contour.length<2)return!1;o.globalCompositeOperation="destination-over",o.fillStyle=t.mback,o.strokeStyle=t.mborder,o.lineWidth=1,o.beginPath(),o.moveTo(t.contour[0],t.contour[1]);for(var n=0;n<t.contour.length;n+=2)o.fillRect(t.contour[n]-t.msize,t.contour[n+1]-t.msize,2*t.msize,2*t.msize),o.strokeRect(t.contour[n]-t.msize,t.contour[n+1]-t.msize,2*t.msize,2*t.msize),t.contour.length>2&&n>1&&o.lineTo(t.contour[n],t.contour[n+1]);o.closePath(),o.fillStyle=t.cback,o.strokeStyle=t.cborder,o.fill(),o.stroke()},h=function(o){options=t(this).data(),o.offsetX||(o.offsetX=o.pageX-t(o.target).offset().left,o.offsetY=o.pageY-t(o.target).offset().top),options.contour[r]=Math.round(o.offsetX),options.contour[r+1]=Math.round(o.offsetY),a(options)},c=function(){t(this).unbind("mousemove"),r=null},u=function(o){options=t(this).data(),o.preventDefault(),o.offsetX||(o.offsetX=o.pageX-t(o.target).offset().left,o.offsetY=o.pageY-t(o.target).offset().top);for(var n=o.offsetX,i=o.offsetY,e=0;e<options.contour.length;e+=2)if(dis=Math.sqrt(Math.pow(n-options.contour[e],2)+Math.pow(i-options.contour[e+1],2)),dis<6)return options.contour.splice(e,2),a(options),!1;return!1},s=function(n){options=t(this).data();var i,s,u,c,d=options.contour.length;if(3===n.which)return!1;if(n.preventDefault(),n.offsetX||(n.offsetX=n.pageX-t(n.target).offset().left,n.offsetY=n.pageY-t(n.target).offset().top),i=n.offsetX,s=n.offsetY,1==options.magicStick){var p=document.createElement("canvas"),g=p.getContext("2d");g.canvas.width=options.width,g.canvas.height=options.height;var l=new Image;l.src=options.src,g.drawImage(l,0,0,options.width,options.height);var m=g.getImageData(0,0,options.width,options.height),v=o(m.data,parseInt(options.width),parseInt(options.height),i,s,options);for(v=e(v,1),points=[],b=0;b<v.length-1;b++)points.push(v[b][0],v[b][1]);options.contour=points,t(this).data({contour:points,magicStick:0}),t(this).data("sourceObject").trigger("magicStickChange")}else{for(var b=0;b<options.contour.length;b+=2)if(u=Math.sqrt(Math.pow(i-options.contour[b],2)+Math.pow(s-options.contour[b+1],2)),6>u)return r=b,t(this).bind("mousemove",h),!1;for(var b=0;b<options.contour.length;b+=2)b>1&&(c=f(i,s,options.contour[b],options.contour[b+1],options.contour[b-2],options.contour[b-1],!0),6>c&&(d=b));options.contour.splice(d,0,Math.round(i),Math.round(s)),r=d,t(this).bind("mousemove",h)}return a(options),!1}}(jQuery);
